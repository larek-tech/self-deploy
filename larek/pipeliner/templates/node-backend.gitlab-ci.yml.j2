# GitLab CI Pipeline for {{ service.name }} (Backend)
# Language: {{ service.lang.name | capitalize }} (Node.js {{ node_version }})

stages:
{% for stage in stages %}
  - {{ stage }}
{% endfor %}

variables:
  NODE_VERSION: "{{ node_version }}"
{% if has_dockerfiles %}
  NEXUS_REGISTRY: "${NEXUS_REGISTRY:-localhost:8081}"
  NEXUS_USER: "${NEXUS_USER:-admin}"
  NEXUS_PASSWORD: "${NEXUS_PASSWORD}"
{% endif %}

.node-cache: &node-cache
  cache:
    key: "${CI_COMMIT_REF_SLUG}-node"
    paths:
{% if package_manager == 'yarn' %}
      - .yarn/cache/
{% elif package_manager == 'pnpm' %}
      - .pnpm-store/
{% else %}
      - node_modules/
{% endif %}

.node-setup: &node-setup
  before_script:
{% if package_manager == 'pnpm' %}
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm config set store-dir .pnpm-store
{% endif %}
    - {{ install_command }}

{% if has_lint %}
lint:
  stage: lint
  image: node:{{ node_version }}-alpine
  <<: *node-cache
  <<: *node-setup
  script:
    - {{ lint_command }}
{% if is_typescript %}
    - {{ package_manager }}{% if package_manager == 'npm' %} run{% endif %} tsc --noEmit
{% endif %}
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
{% endif %}

{% if has_test %}
test:
  stage: test
  image: node:{{ node_version }}-alpine
  <<: *node-cache
  <<: *node-setup
  script:
    - {{ test_command }}
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
{% endif %}

{% if is_typescript %}
build:
  stage: build
  image: node:{{ node_version }}-alpine
  <<: *node-cache
  <<: *node-setup
  script:
    - {{ build_command }}
  artifacts:
    paths:
      - dist/
      - lib/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
{% endif %}

{% include '_docker.gitlab-ci.yml.j2' %}

{% if has_s3 %}
s3:
  stage: s3
  image: minio/mc
  script:
    - if [ -z "$S3_ENDPOINT" ] || [ -z "$S3_BUCKET" ] || [ -z "$S3_ACCESS_KEY" ] || [ -z "$S3_SECRET_KEY" ]; then echo "Missing S3 variables"; exit 1; fi
    - mc alias set deploy "$S3_ENDPOINT" "$S3_ACCESS_KEY" "$S3_SECRET_KEY" --api S3v4 || true
    - mc cp --recursive ./dist deploy/$S3_BUCKET/
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
{% endif %}
