# GitLab CI Pipeline for Monorepo
# Generated by larek CLI
# Services: {{ services | map(attribute='name') | join(', ') }}

stages:
  - deploy
{% for stage in stages %}
  - {{ stage }}
{% endfor %}

# =============================================================================
# Manual helper jobs
# =============================================================================

# Manual debug job — run quick diagnostics on CI runner when triggered manually
pipeline:debug:
  stage: deploy
  image: alpine:latest
  rules:
    - when: manual
  script:
    - echo "--- CI runner diagnostics ---"
    - uname -a || true
    - echo "--- env vars (filtered) ---"
    - env | grep -E 'CI_|GITLAB' || true
    - echo "--- build yaml ---"
    - cat .larek/build.yaml
    - echo "--- workspace top-level ---"
    - ls -la || true
    - echo "--- services in this pipeline ---"
    - |
      for svc in {{ services | map(attribute='name') | join(' ') }}; do
        echo "service: $svc" || true
      done
  allow_failure: true

# Manual restart job — attempts to trigger a new pipeline for the default branch
# Requires either `GITLAB_TRIGGER_TOKEN` or `CI_JOB_TOKEN` to be available as a variable
pipeline:restart:
  stage: deploy
  image: curlimages/curl:8.17.0
  rules:
    - when: manual
  script:
    - |
      if [ -z "${GITLAB_TRIGGER_TOKEN:-}" ] && [ -z "${CI_JOB_TOKEN:-}" ]; then
        echo "No trigger token provided (set GITLAB_TRIGGER_TOKEN or rely on CI_JOB_TOKEN).";
        echo "To trigger remotely, set project trigger token or provide CI_JOB_TOKEN.";
        exit 0;
      fi
    - echo "Triggering pipeline for project ${CI_PROJECT_ID} on ref ${CI_DEFAULT_BRANCH}..."
    - |
      TRIG_TOKEN=${GITLAB_TRIGGER_TOKEN:-$CI_JOB_TOKEN};
      API_URL="${CI_API_V4_URL:-https://${CI_SERVER_HOST:-gitlab.example.com}/api/v4}";
      curl -sS --fail -X POST "${API_URL}/projects/${CI_PROJECT_ID}/trigger/pipeline" \
        -F token="${TRIG_TOKEN}" -F ref="${CI_DEFAULT_BRANCH}" || echo "Trigger API call failed (see above)";
  allow_failure: true
variables:
  NEXUS_REGISTRY: "${NEXUS_REGISTRY:-localhost:8081}"
  NEXUS_USER: "${NEXUS_USER:-admin}"
  NEXUS_PASSWORD: "${NEXUS_PASSWORD}"

# =============================================================================
# Shared Templates
# =============================================================================

.docker-build-template: &docker-build-template
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_DRIVER: overlay2
  before_script:
    - docker login -u "${NEXUS_USER}" -p "${NEXUS_PASSWORD}" "${NEXUS_REGISTRY}"

# Rules for changes detection per service
{% for cfg in service_configs %}
.{{ cfg.service.name | replace('-', '_') }}-changes: &{{ cfg.service.name | replace('-', '_') }}_changes
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - {{ cfg.display_path or cfg.service.path }}/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - {{ cfg.display_path or cfg.service.path }}/**/*
    - if: $CI_COMMIT_TAG

{% endfor %}

# =============================================================================
# Service Jobs
# =============================================================================
{% for svc_config in service_configs %}

# -----------------------------------------------------------------------------
# {{ svc_config.service.name }} ({{ svc_config.service.lang.name }})
# -----------------------------------------------------------------------------
{% set workdir = (svc_config.dockerfiles[0].context if svc_config.dockerfiles and svc_config.dockerfiles[0].context else (svc_config.display_path or svc_config.service.path)) %}
{% if svc_config.has_lint %}

{{ svc_config.service.name }}:lint:
  stage: lint
  image: {{ svc_config.lint_image }}
  <<: *{{ svc_config.service.name | replace('-', '_') }}_changes
{% if svc_config.cache %}
  cache:
    key: "${CI_COMMIT_REF_SLUG}-{{ svc_config.service.name }}"
    paths:
{{ svc_config.cache | indent(6, first=True) }}
{% endif %}
  before_script:
    - cd {{ workdir }}
{% if svc_config.before_script %}
{{ svc_config.before_script | indent(4, first=True) }}
{% endif %}
  script:
    - {{ svc_config.lint_command }}
  allow_failure: true
{% endif %}
{% if svc_config.has_test %}

{{ svc_config.service.name }}:test:
  stage: test
  image: {{ svc_config.test_image }}
  <<: *{{ svc_config.service.name | replace('-', '_') }}_changes
{% if svc_config.cache %}
  cache:
    key: "${CI_COMMIT_REF_SLUG}-{{ svc_config.service.name }}"
    paths:
{{ svc_config.cache | indent(6, first=True) }}
{% endif %}
  before_script:
    - cd {{ workdir }}
{% if svc_config.before_script %}
{{ svc_config.before_script | indent(4, first=True) }}
{% endif %}
  script:
    - {{ svc_config.test_command }}
  coverage: '{{ svc_config.coverage_regex }}'
  artifacts:
    reports:
      junit: {{ (svc_config.display_path or svc_config.service.path) }}/report.xml
    when: always
{% endif %}
{% if svc_config.has_build %}

{{ svc_config.service.name }}:build:
  stage: build
  image: {{ svc_config.build_image }}
  <<: *{{ svc_config.service.name | replace('-', '_') }}_changes
{% if svc_config.cache %}
  cache:
    key: "${CI_COMMIT_REF_SLUG}-{{ svc_config.service.name }}"
    paths:
{{ svc_config.cache | indent(6, first=True) }}
{% endif %}
  before_script:
    - cd {{ workdir }}
{% if svc_config.before_script %}
{{ svc_config.before_script | indent(4, first=True) }}
{% endif %}
  script:
{% for cmd in svc_config.build_commands %}
    - {{ cmd }}
{% endfor %}
  artifacts:
    paths:
      - {{ (svc_config.display_path or svc_config.service.path) }}/{{ svc_config.artifacts_path }}
    expire_in: 1 week
{% endif %}
{% if svc_config.has_docker %}
{% for dockerfile in svc_config.dockerfiles %}

{{ svc_config.service.name }}:docker{% if loop.length > 1 %}-{{ loop.index }}{% endif %}:
  stage: docker
  <<: *docker-build-template
  <<: *{{ svc_config.service.name | replace('-', '_') }}_changes
  script:
    - export IMAGE_TAG="${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    - docker build -f {{ dockerfile.dockerfile }} -t "${NEXUS_REGISTRY}/{{ svc_config.service.name }}:${IMAGE_TAG}" {{ dockerfile.context }}
    - docker push "${NEXUS_REGISTRY}/{{ svc_config.service.name }}:${IMAGE_TAG}"
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag "${NEXUS_REGISTRY}/{{ svc_config.service.name }}:${IMAGE_TAG}" "${NEXUS_REGISTRY}/{{ svc_config.service.name }}:latest"
        docker push "${NEXUS_REGISTRY}/{{ svc_config.service.name }}:latest"
      fi
{% endfor %}
{% endif %}
{% endfor %}
