---
- name: GitLab Production Setup (Idempotent)
  hosts: gitlab_servers
  become: yes
  vars:
    gitlab_edition: "gitlab-ce"
    gitlab_external_url: "http://{{ ansible_default_ipv4.address }}"
    gitlab_backup_path: "/var/opt/gitlab/backups"
    gitlab_initial_password_file: "/etc/gitlab/initial_root_password"

  tasks:
    # ===== SYSTEM PREPARATION =====
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install system dependencies
      package:
        name:
          - curl
          - openssh-server
          - ca-certificates
          - tzdata
          - perl
          - postfix
        state: present

    - name: Clean up any stuck apt processes
      shell: |
        pkill -f "apt-get" || true
        pkill -f "unattended-upgrade" || true
        rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock
      ignore_errors: yes
      changed_when: false

    # ===== GITLAB REPOSITORY SETUP =====
    - name: Check if GitLab repository exists
      stat:
        path: /etc/apt/sources.list.d/gitlab_official.list
      register: gitlab_repo_exists
      when: ansible_os_family == "Debian"

    - name: Add GitLab official GPG key
      apt_key:
        url: https://packages.gitlab.com/gpg.key
        state: present
      when: ansible_os_family == "Debian" and not gitlab_repo_exists.stat.exists

    - name: Add GitLab repository
      apt_repository:
        repo: "deb https://packages.gitlab.com/gitlab/{{ gitlab_edition }}/ubuntu/ {{ ansible_distribution_release }} main"
        state: present
        filename: gitlab_official
      when: ansible_os_family == "Debian" and not gitlab_repo_exists.stat.exists

    # ===== GITLAB INSTALLATION =====
    - name: Check if GitLab package is installed
      package_facts:
        manager: apt
      register: package_facts
    
    - name: Debug package facts
      debug:
        var: package_facts.ansible_facts.packages

    - name: Debug package facts
      debug:
        var: gitlab_edition not in package_facts.ansible_facts.packages

    - name: Install GitLab package and ensure full installation
      package:
        name: "{{ gitlab_edition }}"
        state: present
        update_cache: yes
      environment:
        EXTERNAL_URL: "{{ gitlab_external_url }}"
        DEBIAN_FRONTEND: noninteractive
      when: ansible_facts.all_files is not defined or not ansible_facts.all_files.gitlab_ctl
      register: gitlab_installed
      retries: 3
      delay: 10 

    - name: Ensure /etc/gitlab directory exists
      file:
        path: /etc/gitlab
        state: directory
        owner: root
        group: root
        mode: '0755'
      when: gitlab_edition in package_facts.ansible_facts.packages or gitlab_installed.changed


    # ===== GITLAB CONFIGURATION =====
    - name: Create GitLab configuration
      copy:
        content: |
          # GitLab Configuration - Generated by Ansible
          external_url '{{ gitlab_external_url }}'
          
          # Basic Rails settings
          gitlab_rails['time_zone'] = 'UTC'
          gitlab_rails['backup_keep_time'] = 604800
          
          # Nginx configuration
          nginx['enable'] = true
          nginx['listen_port'] = 80
          nginx['listen_https'] = false
          nginx['redirect_http_to_https'] = false
          
          # Resource optimization
          puma['worker_processes'] = 2
          sidekiq['max_concurrency'] = 25
          postgresql['shared_buffers'] = '256MB'
          
          # Disable unnecessary services for single VM
          prometheus['enable'] = false
          alertmanager['enable'] = false
          gitlab_exporter['enable'] = false
          node_exporter['enable'] = false
          redis_exporter['enable'] = false
          postgres_exporter['enable'] = false
        dest: /etc/gitlab/gitlab.rb
        mode: '0600'
        owner: root
        group: root
        backup: yes
      notify:
        - reconfigure gitlab
        - ensure gitlab running

    - name: Create git user and group
      ansible.builtin.user:
        name: git
        state: present
        create_home: no
        shell: /bin/false
        
    # ===== BACKUP DIRECTORY SETUP =====
    - name: Create backup directory
      file:
        path: "{{ gitlab_backup_path }}"
        state: directory
        owner: git
        group: git
        mode: '0755'

    # ===== FIREWALL CONFIGURATION =====
    - name: Configure firewall (UFW)
      ufw:
        rule: allow
        port: "{{ item }}"
      loop:
        - '80'
        - '22'
      when: ansible_distribution == "Ubuntu"

    # ===== SERVICE VERIFICATION =====
    - name: Wait for GitLab to be fully configured
      wait_for:
        path: "{{ gitlab_initial_password_file }}"
        timeout: 300  # 15 minutes max
      ignore_errors: yes

    - name: Verify GitLab services are running
      shell: gitlab-ctl status
      register: gitlab_status
      changed_when: false
      retries: 5
      delay: 30
      until: gitlab_status.stdout.find('run:') != -1

    - name: Verify GitLab web interface is responding
      uri:
        url: "{{ gitlab_external_url }}"
        method: GET
        status_code: 200
      register: gitlab_web_check
      retries: 10
      delay: 30
      until: gitlab_web_check.status == 200

    # ===== BACKUP CONFIGURATION =====
    - name: Setup GitLab backup cron job
      cron:
        name: "GitLab automated backup"
        minute: "0"
        hour: "2"
        job: "/opt/gitlab/bin/gitlab-backup create CRON=1"
        user: root
        state: present

    # ===== FINAL STATUS REPORT =====
    - name: Get GitLab version info
      shell: gitlab-rake gitlab:env:info | grep "GitLab information" || echo "Version info not available"
      register: gitlab_version
      changed_when: false

    - name: Display GitLab access information
      debug:
        msg:
          - "GitLab installation completed successfully!"
          - "Access URL: {{ gitlab_external_url }}"
          - "Username: root"
          - "Password file: {{ gitlab_initial_password_file }}"
          - "{{ gitlab_version.stdout }}"
          - "Run 'sudo cat {{ gitlab_initial_password_file }}' to get the initial password"

  handlers:
    - name: reconfigure gitlab
      shell: gitlab-ctl reconfigure
      register: reconfigure_result
      retries: 3
      delay: 60
      until: reconfigure_result.rc == 0

    - name: ensure gitlab running
      shell: |
        gitlab-ctl start
        sleep 30
        gitlab-ctl status
      register: start_result
      retries: 3
      delay: 30
      until: start_result.stdout.find('run:') != -1